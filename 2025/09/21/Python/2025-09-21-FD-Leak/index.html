<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  
  <meta name="description" content="AI | NLP | 人工智能 | 哲学 | 自然语言处理 | 机器学习">
  

  
  
  
  
  
  <title>记一次诡异的 FD 泄露：躲在暗处的猴子补丁 | Yam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文记录一次线上服务关于 FD 泄露的 Bug 排查经历。相关代码：hscspring/fd_leak: fd leak caused by monkey patch.[1]  引子：线上服务频频告警，一切迹象都指向了再常见不过的 FD 耗尽问题。然而，这次的排查之旅却像一场侦探游戏，线索若隐若现，真相几度反转。最终，我们揪出的元凶竟是一个“躲在暗处”的猴子补丁（Monkey Patch），而触发">
<meta name="keywords" content="Python,FD Leak,Monkey Patch,Eventlet,Sentry">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次诡异的 FD 泄露：躲在暗处的猴子补丁">
<meta property="og:url" content="https://yam.gift/2025/09/21/Python/2025-09-21-FD-Leak/index.html">
<meta property="og:site_name" content="Yam">
<meta property="og:description" content="本文记录一次线上服务关于 FD 泄露的 Bug 排查经历。相关代码：hscspring/fd_leak: fd leak caused by monkey patch.[1]  引子：线上服务频频告警，一切迹象都指向了再常见不过的 FD 耗尽问题。然而，这次的排查之旅却像一场侦探游戏，线索若隐若现，真相几度反转。最终，我们揪出的元凶竟是一个“躲在暗处”的猴子补丁（Monkey Patch），而触发">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2025-09-25T00:35:09.169Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次诡异的 FD 泄露：躲在暗处的猴子补丁">
<meta name="twitter:description" content="本文记录一次线上服务关于 FD 泄露的 Bug 排查经历。相关代码：hscspring/fd_leak: fd leak caused by monkey patch.[1]  引子：线上服务频频告警，一切迹象都指向了再常见不过的 FD 耗尽问题。然而，这次的排查之旅却像一场侦探游戏，线索若隐若现，真相几度反转。最终，我们揪出的元凶竟是一个“躲在暗处”的猴子补丁（Monkey Patch），而触发">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  

  
  <!-- baidu webmaster push -->
<link rel="alternate" href="/atom.xml" title="Yam" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /><!-- hexo-inject:begin --><!-- hexo-inject:end --></head></html>
<body class="home blog custom-background custom-font-enabled single-author">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
    <hgroup>
      <h1 class="site-title">
        <a href="/" title="Yam" rel="home">Yam</a>
      </h1>
      
        <h2 class="site-description">
          <a href="/" id="subtitle">Feeling, Coding, Thinking</a>
        </h2>
      
    </hgroup>

    <nav id="site-navigation" class="main-navigation" role="navigation">
            <button class="menu-toggle">菜单</button>
            <a class="assistive-text" href="/#content" title="跳至内容">跳至内容</a><!--TODO-->
            <div class="menu-main-container">
                <ul id="menu-main" class="nav-menu">
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Home</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/series/">Series</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/archives/">Archives</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/about/">About</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://github.com/hscspring">Projects</a></li>
                
                </ul>
            </div>
    </nav>
</header>
      <div id="main" class="wrapper">
        <div id="primary" class="site-content"><div id="content" role="main"><article id="post-Python/2025-09-21-FD-Leak" class="post-Python/2025-09-21-FD-Leak post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title article-title">
      记一次诡异的 FD 泄露：躲在暗处的猴子补丁
    </h1>
  

        
        <!-- <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://yam.gift/2025/09/21/Python/2025-09-21-FD-Leak/" data-id="cmfsjpo8300008vbzw82hm8y2" class="leave-reply bdsharebuttonbox" data-cmd="more"></a>
        </div> --><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
            <!-- Table of Contents -->
              
        <p>本文记录一次线上服务关于 FD 泄露的 Bug 排查经历。相关代码：<a href="https://github.com/hscspring/fd_leak" target="_blank" rel="noopener">hscspring/fd_leak: fd leak caused by monkey patch.</a><sup>[1]</sup></p>
<blockquote>
<p>引子：线上服务频频告警，一切迹象都指向了再常见不过的 FD 耗尽问题。然而，这次的排查之旅却像一场侦探游戏，线索若隐若现，真相几度反转。最终，我们揪出的元凶竟是一个“躲在暗处”的<strong>猴子补丁（Monkey Patch）</strong>，而触发它作案的，则是一两行看似人畜无害的<strong>导入语句</strong>。</p>
</blockquote>
<a id="more"></a>
<h2 id="问题背景">问题背景</h2>
<p>某天，报警系统突然出现下面的错误日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by NewConnectionError(<span class="string">'&lt;urllib3.connection.HTTPSConnection object at 0x7fd77cfd8b10&gt;: Failed to establish a new connection: [Errno 16] Device or resource busy'</span>)</span><br></pre></td></tr></table></figure>
<p>这个我们知道一般是文件描述符（FD）耗尽导致。用下面的命令查看确认后确实如此。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n <span class="comment"># 1024</span></span><br><span class="line">lsof -p pid |wc -l <span class="comment"># 1369</span></span><br></pre></td></tr></table></figure>
<p>重启后会正常，但运行一段时间后又出现了。</p>
<p>好了，问题找到了，但是为什么呢？</p>
<h2 id="服务描述">服务描述</h2>
<p>首先，这是一个 LLM 相关的流式服务，这个服务作为 Server 同时会请求第三方 LLM 的 API，我们可以简单将其理解为对第三方流式数据的转发。</p>
<p>其次，该服务本身并没有多线程相关逻辑和代码，不存在多线程调用 API。</p>
<p>第三，该服务的并发并不高，请求数也不是特别多。但每次输出的 Token 数比较多，一次请求从开始到结束可达到 10-30 秒以上。</p>
<p>总的来说，是一个回复长度比较长的流式 LLM 服务。</p>
<h2 id="问题定位">问题定位</h2>
<p>第一反应是自己发起的请求没正确释放或者没释放，导致 FD 不断累积，请求未释放或未完成确实会导致 FD 耗尽，我们可以用下面代码实验一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find/repro.py</span></span><br><span class="line"><span class="comment"># Server端不处理</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line">PORT = <span class="number">8022</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_hang_server</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HangHandler</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">            self.send_response(<span class="number">200</span>)</span><br><span class="line">            self.send_header(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            <span class="comment"># Server 端卡死</span></span><br><span class="line">            time.sleep(<span class="number">30</span>)</span><br><span class="line">    server = HTTPServer((<span class="string">"localhost"</span>, PORT), HangHandler)</span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br><span class="line">threading.Thread(target=start_hang_server).start()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">stop_flag = <span class="literal">False</span></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_conn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> stop_flag</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = session.get(</span><br><span class="line">            <span class="string">f"http://localhost:<span class="subst">&#123;PORT&#125;</span>"</span>,</span><br><span class="line">            stream=<span class="literal">True</span>,</span><br><span class="line">            timeout=<span class="number">10</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> resp.iter_lines():</span><br><span class="line">            <span class="keyword">if</span> v:</span><br><span class="line">                print(<span class="string">f"Received: <span class="subst">&#123;v.decode(<span class="string">'utf-8'</span>)&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f"Got exception in thread: <span class="subst">&#123;e!r&#125;</span>"</span>)</span><br><span class="line">        <span class="comment"># 如果是 Errno 16，就能看到类似 Device or resource busy</span></span><br><span class="line">        <span class="keyword">with</span> lock:</span><br><span class="line">            stop_flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> stop_flag:</span><br><span class="line">        print(<span class="string">"Encountered failure, exiting loop."</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    t = threading.Thread(target=open_conn)</span><br><span class="line">    t.daemon = <span class="literal">True</span></span><br><span class="line">    t.start()</span><br><span class="line">    threads.append(t)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    print(<span class="string">f"Opened connections: <span class="subst">&#123;count&#125;</span>"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>
<p>设置<code>ulimit -n 10</code>，或者更小，运行后马上就会遇到 <code>Errno 16</code>。Server 端卡住，Client 一直发很快就会到达ulimit上限，导致 Device or resource busy，这样当然是没问题的（显而易见）。</p>
<p>现在的问题是，Server 端大概率是没问题的（毕竟用了很长时间了），不确定自己代码里调用 Server 端时是否遇到「错误」导致连接未成功释放，毕竟我这个也是服务，而不是一个脚本任务。如果是，那确定是这个问题；如果不是，那一定有其他什么占用了 FD，导致无法发起新的连接。再模拟实验一下，让 Client 模拟抛出异常，不正常释放 Server 的 stream 流，看看会不会耗尽 FD。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find/main.py</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> StreamingResponse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_stream</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">f"<span class="subst">&#123;i&#125;</span>\n"</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stream_text</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(generate_stream(), media_type=<span class="string">"text/plain"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># find/client.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">adapter = requests.adapters.HTTPAdapter(pool_connections=<span class="number">2</span>, pool_maxsize=<span class="number">2</span>)</span><br><span class="line">session.mount(<span class="string">"http://"</span>, adapter)</span><br><span class="line">session.mount(<span class="string">"https://"</span>, adapter)</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://localhost:8022"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_leak</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">f"[Thread-<span class="subst">&#123;i&#125;</span>] start"</span>)</span><br><span class="line">        resp = session.get(url, stream=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> resp.iter_lines():</span><br><span class="line">            print(<span class="string">f"[Thread-<span class="subst">&#123;i&#125;</span>] line: <span class="subst">&#123;line&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b"2"</span> <span class="keyword">in</span> line:</span><br><span class="line">                <span class="comment"># 模拟异常中断，连接不释放</span></span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"simulate disconnect"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f"[Thread-<span class="subst">&#123;i&#125;</span>] Exception: <span class="subst">&#123;e&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    t = threading.Thread(target=make_leak, args=(i,))</span><br><span class="line">    t.start()</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    threads.append(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>
<p>还是设置<code>ulimit -n 10</code>，<code>time.sleep()</code>设置到比较小时（比如0.1），自然很快就报错了，那是因为新创建的连接太多了，一下就超过了 FD 的限制，但是如果我们把它调大点，比如调到 0.5 或 1，那么随便怎么执行都不会报错。因为请求 2s 结束（抛出异常），2s 可以发送 2/0.5=4 个请求，达不到限制的 10。实际上即使调到 0.3 也不会报错，极限是 2/10=0.2s，但显然这是理想值，实际可能需要 0.3。这也说，我们发起的流式请求即使没有正常释放，问题依然不大，不会导致 FD 增加。</p>
<p>还可以通过命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anp | grep 32215 | awk <span class="string">'&#123;print $6&#125;'</span> | sort | uniq -c</span><br></pre></td></tr></table></figure>
<p>查看状态分布，CLOSE_WAIT 并没有很多，说明并没有异常挂起的连接。</p>
<p>那就是其他地方有问题了！看下有哪些 FD（进程打开的文件）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p 32215 | awk <span class="string">'&#123;print $5&#125;'</span> | sort | uniq -c | sort -nr</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">308 REG </span><br><span class="line">668 a_inode </span><br><span class="line">34 CHR </span><br><span class="line">26 IPv4 </span><br><span class="line">10 FIFO </span><br><span class="line">2 DIR </span><br><span class="line">1 unix </span><br><span class="line">1 TYPE</span><br></pre></td></tr></table></figure>
<p>含义如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">308 REG        ← 普通文件（日志、Python 模块、库、缓存等）</span><br><span class="line">668 a_inode    ← lsof监控的文件，inode是文件的唯一标识符</span><br><span class="line"> 34 CHR        ← 字符设备（stdin、stdout、stderr）</span><br><span class="line"> 26 IPv4       ← IPv4套接字</span><br><span class="line"> 10 FIFO       ← 先进先出队列</span><br><span class="line">  2 DIR        ← 目录</span><br><span class="line">  1 unix       ← Unix domain套接字</span><br><span class="line">  1 TYPE       ← lsof 内部标识</span><br></pre></td></tr></table></figure>
<p>进程没有大量 TCP socket，也没泄露网络连接！比较多的是 REG 和 a_inode，经确认，REG是正常的，确实有那么多。那么看看 a_inode 都有些啥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p 32215 | grep a_inode</span><br></pre></td></tr></table></figure>
<p>结果好多<code>eventpoll</code>，它是Linux 系统中的一个系统调用，用于高效地监听多个文件描述符上的 I/O 事件。由于需要运行一段时间才会出现，很自然想监控一下随时间推移 FD 的变化，结果发现 a_node 居然会随时间增加！这应该就是 FD 泄露的直接原因。</p>
<p>但是显然，大部分情况下没有谁代码里能用到<code>epoll</code>这么底层的调用，所以肯定有一些不为人知的模块有问题。接下来就是要找出具体是哪个地方用到了这个。</p>
<p>直接使用 <code>py-spy</code> 看线程堆栈中哪个线程一直持有资源不释放。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py-spy dump --pid 32215</span><br></pre></td></tr></table></figure>
<p>执行后，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只显示epoll相关</span></span><br><span class="line">Thread 1605012 (idle): <span class="string">"Thread-4 (start)"</span></span><br><span class="line">    do_poll (eventlet/hubs/epolls.py:31)</span><br><span class="line">    <span class="built_in">wait</span> (eventlet/hubs/poll.py:80)</span><br><span class="line">    run (eventlet/hubs/hub.py:362)</span><br></pre></td></tr></table></figure>
<p>果然找到了相关的线程，和 <code>eventlet</code> 这个包有关。不过这个我自己代码里没用到，应该是某个依赖用到了。直接卸载后重启服务，果然正常了！</p>
<p>接下来就是找到是谁用了它。服务命令启动时加入 <code>PYTHONPROFILEIMPORTTIME=1</code> 分析引入链，将结果输出后，grep <code>eventlet</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep eventlet import.log -C 10</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import time:       347 |        347 |       redis.asyncio.utils</span><br><span class="line">import time:       617 |      38094 |     redis.asyncio</span><br><span class="line">import time:       511 |        511 |     redis.sentinel</span><br><span class="line">import time:      1060 |      39664 |   redis</span><br><span class="line">import time:       436 |        436 |         sentry_sdk._types</span><br><span class="line">import time:       354 |        790 |       sentry_sdk._compat</span><br><span class="line">import time:       692 |        692 |       sentry_sdk.consts</span><br><span class="line">import time:       170 |        170 |                 gevent</span><br><span class="line">import time:       551 |        551 |                   greenlet._greenlet</span><br><span class="line">import time:       444 |        994 |                 greenlet</span><br><span class="line">import time:       471 |        471 |                               eventlet.patcher</span><br><span class="line">......</span><br><span class="line">import time:       529 |     370559 |                   eventlet</span><br><span class="line">import time:        12 |     370570 |                 eventlet.patcher</span><br><span class="line">import time:       148 |        148 |                 gevent</span><br><span class="line">import time:      1942 |     373822 |               sentry_sdk.utils</span><br><span class="line">import time:       375 |     374197 |             sentry_sdk.session</span><br><span class="line">import time:       420 |     374617 |           sentry_sdk.envelope</span><br><span class="line">import time:       353 |     374969 |         sentry_sdk.attachments</span><br><span class="line">import time:       353 |        353 |           sentry_sdk._lru_cache</span><br><span class="line">import time:       148 |        148 |             gevent</span><br><span class="line">import time:        13 |        160 |           gevent.monkey</span><br><span class="line">import time:       597 |       1109 |         sentry_sdk.profiler</span><br><span class="line">import time:       879 |        879 |             sentry_sdk.metrics</span><br></pre></td></tr></table></figure>
<p>找到了，是 <code>sentry_sdk</code> 引入了 <code>eventlet</code>！找到相关代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sentry_sdk/utils.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_is_contextvars_broken</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># type: () -&gt; bool</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Returns whether gevent/eventlet have patched the stdlib in a way where thread locals are now more "correct" than contextvars.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> gevent  <span class="comment"># type: ignore</span></span><br><span class="line">        <span class="keyword">from</span> gevent.monkey <span class="keyword">import</span> is_object_patched  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the MAJOR and MINOR version numbers of Gevent</span></span><br><span class="line">        version_tuple = tuple(</span><br><span class="line">            [int(part) <span class="keyword">for</span> part <span class="keyword">in</span> re.split(<span class="string">r"a|b|rc|\."</span>, gevent.__version__)[:<span class="number">2</span>]]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> is_object_patched(<span class="string">"threading"</span>, <span class="string">"local"</span>):</span><br><span class="line">            <span class="comment"># Gevent 20.9.0 depends on Greenlet 0.4.17 which natively handles switching</span></span><br><span class="line">            <span class="comment"># context vars when greenlets are switched, so, Gevent 20.9.0+ is all fine.</span></span><br><span class="line">            <span class="comment"># Ref: https://github.com/gevent/gevent/blob/83c9e2ae5b0834b8f84233760aabe82c3ba065b4/src/gevent/monkey.py#L604-L609</span></span><br><span class="line">            <span class="comment"># Gevent 20.5, that doesn't depend on Greenlet 0.4.17 with native support</span></span><br><span class="line">            <span class="comment"># for contextvars, is able to patch both thread locals and contextvars, in</span></span><br><span class="line">            <span class="comment"># that case, check if contextvars are effectively patched.</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment"># Gevent 20.9.0+</span></span><br><span class="line">                (sys.version_info &gt;= (<span class="number">3</span>, <span class="number">7</span>) <span class="keyword">and</span> version_tuple &gt;= (<span class="number">20</span>, <span class="number">9</span>))</span><br><span class="line">                <span class="comment"># Gevent 20.5.0+ or Python &lt; 3.7</span></span><br><span class="line">                <span class="keyword">or</span> (is_object_patched(<span class="string">"contextvars"</span>, <span class="string">"ContextVar"</span>))</span><br><span class="line">            ):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> greenlet  <span class="comment"># type: ignore</span></span><br><span class="line">        <span class="keyword">from</span> eventlet.patcher <span class="keyword">import</span> is_monkey_patched  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">        greenlet_version = parse_version(greenlet.__version__)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> greenlet_version <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">"Internal error in Sentry SDK: Could not parse Greenlet version from greenlet.__version__."</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_monkey_patched(<span class="string">"thread"</span>) <span class="keyword">and</span> greenlet_version &lt; (<span class="number">0</span>, <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_contextvars</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># type: () -&gt; Tuple[bool, type]</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Figure out the "right" contextvars installation to use. Returns a</span></span><br><span class="line"><span class="string">    `contextvars.ContextVar`-like class with a limited API.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    See https://docs.sentry.io/platforms/python/contextvars/ for more information.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_contextvars_broken():</span><br><span class="line">        <span class="comment"># aiocontextvars is a PyPI package that ensures that the contextvars</span></span><br><span class="line">        <span class="comment"># backport (also a PyPI package) works with asyncio under Python 3.6</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Import it if available.</span></span><br><span class="line">        <span class="keyword">if</span> sys.version_info &lt; (<span class="number">3</span>, <span class="number">7</span>):</span><br><span class="line">            <span class="comment"># `aiocontextvars` is absolutely required for functional</span></span><br><span class="line">            <span class="comment"># contextvars on Python 3.6.</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">from</span> aiocontextvars <span class="keyword">import</span> ContextVar</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, ContextVar</span><br><span class="line">            <span class="keyword">except</span> ImportError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># On Python 3.7 contextvars are functional.</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">from</span> contextvars <span class="keyword">import</span> ContextVar</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, ContextVar</span><br><span class="line">            <span class="keyword">except</span> ImportError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Fall back to basic thread-local usage.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> threading <span class="keyword">import</span> local</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>, _make_threadlocal_contextvars(local)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HAS_REAL_CONTEXTVARS, ContextVar = _get_contextvars()</span><br></pre></td></tr></table></figure>
<p>注意，<code>eventlet</code> 和 <code>gevent</code> 都是基于协程（协作式并发）的 Python 并发库，用于在<strong>同步代码中实现高并发 I/O 处理</strong>。</p>
<p>我的环境正好装了 <code>greenlet</code> 和 <code>eventlet</code>，由此可以推断，很可能是因为 <code>eventlet</code>（eventlet==0.36.1）的猴子补丁改变了线程和协程的行为，导致 Sentry 内部上下文追踪、线程同步等机制异常，从而引发资源泄漏。</p>
<p>猴子补丁是指：<strong>在运行时修改已有的类或模块的行为</strong>，而不是通过继承或修改源码来改变它。举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_sleep</span><span class="params">(seconds)</span>:</span></span><br><span class="line">    print(<span class="string">f"pretend sleeping for <span class="subst">&#123;seconds&#125;</span> seconds"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 猴子补丁：替换原来的 time.sleep</span></span><br><span class="line">time.sleep = fake_sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原本应该阻塞的代码，现在变成打印</span></span><br><span class="line">time.sleep(<span class="number">3</span>)   <span class="comment"># 输出：pretend sleeping for 3 seconds</span></span><br></pre></td></tr></table></figure>
<h2 id="解决方案">解决方案</h2>
<p>非常简单，直接卸载 <code>eventlet</code>。</p>
<p>但是，作为一名工程师，显然不能停留在这里就结束，我们还想搞清楚更深层次的原因：到底是哪里的代码，或者说哪一行代码导致的这个问题？很显然，这需要我们把核心逻辑抽出来进一步研究，没想到这一步居然出问题了！</p>
<h2 id="诡异现象">诡异现象</h2>
<p>当我快速把带有<code>sentry_sdk</code>的相关逻辑单独抽出来测试时，奇怪的事情出现了：FD 居然不再增加！这怎么可能呢？回到原项目重新启动跑了一下——没错呀，确实有增加。那么问题一定出在相关逻辑的抽取上！可是看起来确实好像没问题，没办法，只好一点一点剥离代码，删掉一点测试一下，就这一步搞了几个小时，代码都快看烂了。有几次还不小心剥离多了代码，导致上一步没问题，下一步又消失了……没办法，只好再回退回去。</p>
<p>废了半天劲，终于找到导致 FD 泄露的位置了：居然不是 <code>sentry_sdk</code>，而是请求完成后推送日志的逻辑！这尼玛，此时的心情可真是一言难尽。</p>
<p>好吧，此时的我以为是云厂商的 SDK 问题，又把 SDK 的源代码扒拉了一通，边对源代码进行注释后测试，边心里吐槽：“这 SDK 怎么还有 Bug，我记得是用的最新版的啊！”A few moments later……找到了：是 <code>requests</code> 的一个 post 请求！错怪 SDK 了！直接把 SDK 代码挪掉，换成 <code>requests.get(&quot;https://baidu.com&quot;)</code>，没问题，FD 如预期般在泄露！也就是说，请求完成后开线程后台执行 <code>requests</code> 请求导致了 FD 泄露！</p>
<p>这啥嘛！谁能想到在这里呢！但是，如果你以为到这里就结束了的话，那我只能说你太年轻，其实是我太年轻！不过随着年纪的增长，我喜欢这样的“批评”！</p>
<p>因为我把 <code>requests</code> 请求日志那块给简化成了一个 <code>get</code> 操作，所以那块代码自然也就替换掉了，所以我就顺便在原代码前面加了这么几句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ……其他一些包导入，包含项目文件</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    resp = requests.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">    print(<span class="string">f"send log to SLS success."</span>)</span><br></pre></td></tr></table></figure>
<p>这样是有问题的对吧。然后我看这个包的导入在本地项目之后，就想着顺便调整一下，把 <code>requests</code> 放在了前面，结果你猜怎么着，FD 泄露居然消失了！连他么 a_inode 都没创建！搞了半天我只要换个导入顺序就行？WTF！</p>
<p>进一步测试后确认，如果先导入 <code>sentry_sdk</code> 再导入 <code>requests</code>，就会有 FD 泄露，但是如果换一下它俩的导入顺序，一切太平！我是真的无语了。</p>
<p>为了方便大家复现，我尽量模拟我的代码，把简化版的最小可复现代码整了一份，Server 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># strange/main.py</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> StreamingResponse</span><br><span class="line"><span class="keyword">import</span> sentry_sdk</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    resp = requests.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">    print(<span class="string">f"send log success."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        sentry_sdk.init(</span><br><span class="line">            dsn=<span class="string">"http://example@sentry.io/1"</span>,</span><br><span class="line">            auto_enabling_integrations=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        self.input_queue = queue.Queue()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                q, response_queue = self.input_queue.get()</span><br><span class="line">                <span class="keyword">if</span> q <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">                    token = <span class="string">f"token-<span class="subst">&#123;i&#125;</span>"</span></span><br><span class="line">                    response_queue.put(token)</span><br><span class="line">                response_queue.put(<span class="literal">None</span>)</span><br><span class="line">        Thread(target=worker, daemon=<span class="literal">True</span>).start()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, q: str)</span>:</span></span><br><span class="line">        response_queue = queue.Queue()</span><br><span class="line">        self.input_queue.put((q, response_queue))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            token = response_queue.get()</span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f"data: <span class="subst">&#123;token&#125;</span>\n\n"</span></span><br><span class="line">        </span><br><span class="line">        Thread(</span><br><span class="line">            target=send_log,</span><br><span class="line">            args=(),</span><br><span class="line">        ).start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worker = Worker()</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post("/", response_model=None)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">llm_svc</span><span class="params">(q: str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(</span><br><span class="line">        worker.run(q), </span><br><span class="line">        media_type=<span class="string">"text/event-stream"</span>, </span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>很简单的代码，Client 更简单，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># strange/client.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call_service</span><span class="params">(q: str)</span>:</span>  </span><br><span class="line">    url = <span class="string">"http://127.0.0.1:9321/?q=q"</span></span><br><span class="line">    response = requests.post(url, stream=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_lines():</span><br><span class="line">        <span class="keyword">if</span> chunk:</span><br><span class="line">            <span class="keyword">yield</span> chunk.decode(<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        gen = call_service(<span class="string">"hello"</span>)</span><br><span class="line">        <span class="keyword">for</span> cont <span class="keyword">in</span> gen:</span><br><span class="line">            print(<span class="string">f"--&gt;receive cont: <span class="subst">&#123;cont!r&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
<p>我们打开一个 terminal 启动 Server：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvicorn main:app --port 9321</span><br></pre></td></tr></table></figure>
<p>然后打开另一个 terminal 进行验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p $(ps aux|grep uvicorn |grep 9321 | awk <span class="string">'&#123;print $2&#125;'</span>) | awk <span class="string">'&#123;print $5&#125;'</span> | sort | uniq -c | sort -nr</span><br></pre></td></tr></table></figure>
<p>此时看到 <code>a_inode</code> 应该是 3。接下来执行 <code>python client.py</code>，发起 10 次请求后，再执行上面的命令，<code>a_inode</code> 应该是 13。</p>
<p>如果我们将 <code>send_log</code> 中的那行 <code>requests</code> 请求注释掉，<code>a_inode</code> 就一直都是 3。</p>
<p>如果我们将 <code>sentry_sdk</code> 和 <code>requests</code> 的导入换个顺序，<code>a_inode</code> 始终保持为 2。</p>
<p>其实，既然已经知道了问题所在，上面的 Server 代码还可以改的更简单一些，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># strange/main_simple.py</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> StreamingResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sentry_sdk</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">sentry_sdk.init(</span><br><span class="line">    dsn=<span class="string">"http://example@sentry.io/1"</span>,</span><br><span class="line">    auto_enabling_integrations=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    resp = session.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">    print(<span class="string">f"send log success."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stream_tokens</span><span class="params">(q: str)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generator</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f"data: token-<span class="subst">&#123;i&#125;</span>\n\n"</span></span><br><span class="line">        threading.Thread(target=send_log).start()</span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(generator(), media_type=<span class="string">"text/event-stream"</span>)</span><br></pre></td></tr></table></figure>
<p>其他步骤同上，最终的结果也是一样的。另外，如果不是新开线程去执行 <code>send_log</code>，而是直接执行，<code>a_inode</code> 会从 3 变为 4，并一直保持为 4。</p>
<p>也就是说，这个 FD 泄露的直接原因是新开了个线程去执行 <code>requests</code> 请求，但根本原因还是 <code>sentry_sdk</code> 和 <code>requests</code> 导入的问题。</p>
<h2 id="到底为啥">到底为啥</h2>
<p>我先把上面的这个现象丢给了 ChatGPT 老师，它给我了一些解释，并建议给我一个不用 FastAPI 的最小 Demo。其实也很简单，就只要两个包的导入和一个后台（新线程）触发请求的逻辑。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># why/mini.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sentry_sdk</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    requests.get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">    print(<span class="string">"send_log done"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_fds</span><span class="params">()</span>:</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    cmd = <span class="string">f"lsof -p <span class="subst">&#123;pid&#125;</span> | awk '&#123;&#123;print $5&#125;&#125;' | sort | uniq -c | sort -nr"</span></span><br><span class="line">    out = subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line">    print(out.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"初始 FD："</span>)</span><br><span class="line">    show_fds()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多线程触发</span></span><br><span class="line">    threads = [threading.Thread(target=send_log) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>)]</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"\n触发请求后 FD："</span>)</span><br><span class="line">    show_fds()</span><br></pre></td></tr></table></figure>
<p>这样执行后就很容易看出 <code>a_inode</code> 在增加了。ChatGPT 老师给出的解释是：</p>
<blockquote>
<p>这个现象其实是 Python 库导入时的 side effect（副作用）+ requests/urllib3/sentry_sdk 对 epollfd 的使用方式组合 造成的，看似“a_inode 泄漏”，其实是因为依赖初始化顺序导致文件描述符（epoll、eventfd 等）被不同地持有。</p>
<p>每次 requests + urllib3 在多线程下第一次用到时，可能会触发 urllib3 的 连接池管理器 创建后台 selector（用 selectors.EpollSelector），这会新建一个 epoll fd。</p>
<p>同时，sentry_sdk 导入时如果它先 monkey-patch 了一些库（比如 threading 或 requests），就会改变 什么时候 初始化这些 selector/fd。</p>
<p>sentry_sdk import 的时候，它会 import/patch requests 相关模块。这导致当你在子线程里首次调用 requests 时，每个线程可能各自触发 urllib3 的连接池初始化，开多个 epollfd。所以随着请求次数增加，fd 数量上升。</p>
</blockquote>
<p>那既然如此的话，用 <code>urllib3</code> 替换 <code>requests</code> 应该也是一样的，试了一下果然如此。注意，ChatGPT 老师说的不一定都对哦，要仔细甄别和判断。</p>
<p>再回想我们前面的《问题定位》，当时推断：</p>
<p>「很可能是因为 <code>eventlet</code>（eventlet==0.36.1）的猴子补丁改变了线程和协程的行为，导致 Sentry 内部上下文追踪、线程同步等机制异常，从而引发资源泄漏」。</p>
<p>我们把 <code>sentry_sdk</code> 直接替换为 <code>eventlet</code> 导入的那一句试试。好吧，不出所料，问题就在这里！也就是说，出问题的是 <code>sentry_sdk</code> 中的 <code>eventlet</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> eventlet.patcher <span class="keyword">import</span> is_monkey_patched</span><br></pre></td></tr></table></figure>
<p><code>sentry_sdk</code> 本身并无问题。换句话说，可以把导入的地方更换一下也是可以复现的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 换成导入eventlet也是一样的</span></span><br><span class="line"><span class="keyword">import</span> eventlet</span><br><span class="line"><span class="comment"># from eventlet.patcher import is_monkey_patched </span></span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib3.request(<span class="string">"GET"</span>, <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">"send_log done"</span>)</span><br></pre></td></tr></table></figure>
<p>不用请求百度了，只要发起请求就行。同理，这两个导入换个顺序也是正常的。其实到这里我们感觉 ChatGPT 老师说的应该是八九不离十的。</p>
<p>另外，升级了一下 <code>sentry_sdk</code> 到最新版，发现这个地方还是在的，想想应该也是可以理解的，毕竟这不是它的问题。那 <code>eventlet</code> 升级到最新版呢？从 <code>0.36.1</code> 升级到 <code>0.40.3</code> 后发现依然一样。其实也可以理解，站在 <code>eventlet</code> 的角度它也没错。好吧，你们都没错，错的是我……我在导入时忽视了 side effect。这里需要说明一下，实际的代码不可能这么简单，只能说确实是包含 <code>sentry_sdk</code> 的 Python 文件先导入，然后导入了写日志的文件。</p>
<p>继续把新的情况丢给 ChatGPT 老师，显然，这一次的回复看起来更加接近真相。</p>
<blockquote>
<ol>
<li><strong>eventlet 通过 monkey-patch 把标准库（socket、threading、ssl、select 等）替换成“绿色”实现（green）</strong>，从而使阻塞操作可被 eventlet 的协作调度处理。</li>
<li><strong>很多网络库（requests / urllib3 / httplib / ssl / selectors）在第一次导入时会绑定/缓存底层实现</strong>（例如：socket.create_connection、SSLContext、selector 模块的实现等）。如果它们在 monkey_patch 之前被导入，就会绑定到“原生阻塞”的实现；如果在 monkey_patch 之后导入，就会绑定到 eventlet 的 green 实现。</li>
<li>当库的内部使用到某些 I/O 框架（例如 selectors/epoll）或在 N 个线程间创建资源时，<strong>不同实现混用会导致资源（如 epoll fd / eventfd / timerfd / socket fd）没有正确被释放</strong>。这通常表现为“每次发请求后 epollfd 数量上升但不回收”。</li>
<li>因此<strong>导入顺序改变了哪个实现被绑定</strong>，从而影响到是否会产生（或回收）这些底层 FDs。你观察到“把 requests 放在 eventlet 之前就没有泄露”正是这一点的直接体现（但这不是最稳健的修复 —— 正确的是先 monkey_patch，再导入其他库）。</li>
</ol>
</blockquote>
<p>关于 ChatGPT 老师的回复，我们还是秉承一样的理念：提供思路+怀疑精神。</p>
<p>先来看看 <code>eventlet</code> 这个包，经过逐个对下面一系列文件进行排查：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from eventlet.patcher import is_monkey_patched</span></span><br><span class="line"><span class="comment"># from eventlet import convenience</span></span><br><span class="line"><span class="comment"># from eventlet.green import socket</span></span><br><span class="line"><span class="comment"># from eventlet.support import greendns</span></span><br><span class="line"><span class="comment"># from eventlet import greenio</span></span><br><span class="line"><span class="comment"># from eventlet import patcher</span></span><br></pre></td></tr></table></figure>
<p>最终确定应该为 <code>socket</code> 的问题，只要把下面这个代码 <code>modules</code> 中的 <code>socket</code> 注掉就不会有问题了。具体来说，这里的 <code>socket</code> 被替换为绿色实现，然后导入 <code>dns</code> 后 <code>setattr</code> 部分属性时，用到了这个 <code>socket</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eventlet/support/greendns.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> eventlet <span class="keyword">import</span> patcher</span><br><span class="line"><span class="keyword">from</span> eventlet.green <span class="keyword">import</span> _socket_nodns</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">import_patched</span><span class="params">(module_name)</span>:</span></span><br><span class="line">    <span class="comment"># Import cycle note: it's crucial to use _socket_nodns here because</span></span><br><span class="line">    <span class="comment"># regular evenlet.green.socket imports *this* module and if we imported</span></span><br><span class="line">    <span class="comment"># it back we'd end with an import cycle (socket -&gt; greendns -&gt; socket).</span></span><br><span class="line">    <span class="comment"># We break this import cycle by providing a restricted socket module.</span></span><br><span class="line">    </span><br><span class="line">    modules = &#123;</span><br><span class="line">        <span class="string">'select'</span>: select,</span><br><span class="line">        <span class="string">'time'</span>: time,</span><br><span class="line">        <span class="string">'os'</span>: os,</span><br><span class="line">        <span class="comment"># 'socket': _socket_nodns,</span></span><br><span class="line">        <span class="string">'ssl'</span>: ssl,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> patcher.import_patched(module_name, **modules)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dns = import_patched(<span class="string">'dns'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pkg <span class="keyword">in</span> dns.__all__:</span><br><span class="line">    <span class="keyword">if</span> pkg == <span class="string">'rdtypes'</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># if pkg in ["asyncresolver", "asyncquery", "e164", "query", "resolver"]:</span></span><br><span class="line">    <span class="comment">#     continue</span></span><br><span class="line">    setattr(dns, pkg, import_patched(<span class="string">'dns.'</span> + pkg))</span><br></pre></td></tr></table></figure>
<p>显然，此时的 <code>socket</code> 已经变成了绿色版本。同样的情况也发生在 <code>urllib3</code> 的导入过程中。</p>
<p>而如果将下面这个 <code>setattr</code> 部分的注释代码取消注释，也不会有问题。很显然，<code>dns</code> 的这几个属性的 patch 需要进一步查看。经检查，<code>&quot;asyncresolver&quot;, &quot;asyncquery&quot;, &quot;e164&quot;, &quot;resolver&quot;</code> 几个都直接或间接调用了 <code>query</code>，而 <code>query</code>（即 <code>dns/query.py</code>，其他类似）中则尝试去调用了 <code>requests</code>，以及 <code>httpx</code>！注意，<code>dns</code> 可不是标准库。进一步检查后发现，副作用就来自这里的 <code>requests</code>！很显然，把这里的 <code>requests</code> 换成 <code>urllib3</code> 也是一样的效果。</p>
<p>好了，现在我们来梳理一下迄今为止的代码和改动。首先是复现代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># why/mini2.py</span></span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> eventlet</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line">print(<span class="string">"we import urllib3:"</span>, urllib3.socket)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib3.request(<span class="string">"GET"</span>, <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_fds</span><span class="params">()</span>:</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    cmd = <span class="string">f"lsof -p <span class="subst">&#123;pid&#125;</span> | awk '&#123;&#123;print $5&#125;&#125;' | sort | uniq -c | sort -nr"</span></span><br><span class="line">    out = subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line">    print(out.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"初始 FD："</span>)</span><br><span class="line">    show_fds()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多线程触发</span></span><br><span class="line">    threads = [threading.Thread(target=send_log) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"\n触发请求后 FD："</span>)</span><br><span class="line">    show_fds()</span><br></pre></td></tr></table></figure>
<p>然后对下面的包进行调整：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eventlet/support/greendns.py</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"greendns import dns: import_patched(dns) start"</span>)</span><br><span class="line">dns = import_patched(<span class="string">'dns'</span>)</span><br><span class="line">print(<span class="string">"greendns import dns: import_patched(dns) end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pkg <span class="keyword">in</span> dns.__all__:</span><br><span class="line">    <span class="keyword">if</span> pkg == <span class="string">'rdtypes'</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> pkg == <span class="string">"query"</span>:</span><br><span class="line">        print(<span class="string">"greendns setattr start"</span>)</span><br><span class="line">    setattr(dns, pkg, import_patched(<span class="string">'dns.'</span> + pkg))</span><br><span class="line">    print(<span class="string">"greendns setattr end"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dns/__init__.py 最后加一行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">print(<span class="string">"dns import socket: "</span>, socket)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dns/query.py</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	print(<span class="string">"`dns` import urllib3"</span>)</span><br><span class="line">    <span class="keyword">import</span> urllib3</span><br><span class="line">    <span class="comment"># import requests</span></span><br><span class="line">    <span class="comment"># from requests_toolbelt.adapters.source import SourceAddressAdapter</span></span><br><span class="line">    <span class="comment"># from requests_toolbelt.adapters.host_header_ssl import HostHeaderSSLAdapter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># urllib3/__init__.py 加一行</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">print(<span class="string">"urlib3 import socket: "</span>, socket)</span><br></pre></td></tr></table></figure>
<p>注意，几个包的版本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eventlet-0.36.1</span><br><span class="line">urllib3-2.4.0</span><br><span class="line">dnspython-2.3.0</span><br></pre></td></tr></table></figure>
<p>前两个是可以升级到最新版的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eventlet-0.40.3</span><br><span class="line">urllib3-2.5.0</span><br><span class="line">dnspython-2.3.0 <span class="comment"># 这个不要升级</span></span><br></pre></td></tr></table></figure>
<p>但是 <code>dnspython</code> 不行，因为新版已经把 <code>requests</code> 的依赖移除了，自然也就复现不出来了。</p>
<p>执行前面的复现代码后，输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import eventlet （eventlet/support/greendns.py）带来的</span></span><br><span class="line">greendns import dns: import_patched(dns) start</span><br><span class="line">dns import socket:  &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/to/python3.11/site-packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line">greendns import dns: import_patched(dns) end</span><br><span class="line"></span><br><span class="line"><span class="comment"># （eventlet/support/greendns.py）import_patched('dns.' + pkg) 带来的，准确来说是 import  dns.query</span></span><br><span class="line">dns import socket:  &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/to/python3.11/site-packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># dns.query.py 开头我们改掉的那段代码</span></span><br><span class="line">`dns` import urllib3</span><br><span class="line">urlib3 import socket:  &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/to/python3.11/site-packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># setattr带来的</span></span><br><span class="line">greendns setattr start</span><br><span class="line">`dns` import urllib3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复现代码里的</span></span><br><span class="line">we import urllib3: &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/to/python3.11/site-packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line"></span><br><span class="line">初始 FD：</span><br><span class="line">lsof: WARNING: can<span class="string">'t stat() tracefs file system /sys/kernel/debug/tracing</span></span><br><span class="line"><span class="string">      Output information may be incomplete.</span></span><br><span class="line"><span class="string">     56 REG</span></span><br><span class="line"><span class="string">      7 CHR</span></span><br><span class="line"><span class="string">      2 DIR</span></span><br><span class="line"><span class="string">      1 TYPE</span></span><br><span class="line"><span class="string">      1 FIFO</span></span><br><span class="line"><span class="string">      1 a_inode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">触发请求后 FD：</span></span><br><span class="line"><span class="string">lsof: WARNING: can'</span>t <span class="built_in">stat</span>() tracefs file system /sys/kernel/debug/tracing</span><br><span class="line">      Output information may be incomplete.</span><br><span class="line">     56 REG</span><br><span class="line">     11 a_inode</span><br><span class="line">      7 CHR</span><br><span class="line">      2 DIR</span><br><span class="line">      1 TYPE</span><br><span class="line">      1 FIFO</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>socket</code> 已经全部变为绿色版本，如果把 <code>dns/query.py</code> 中的 <code>urllib3</code> 依赖去掉，一切就正常了。说明冲突来自这里的 <code>urllib3</code> 和复现代码里后面导入的 <code>urllib3</code> 。</p>
<p>如果把复现代码中的 <code>urllib3</code> 导入和 <code>eventlet</code> 换个顺序，输出变为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">urlib3 import socket:  &lt;module <span class="string">'socket'</span> from <span class="string">'/path/to/python3.11/socket.py'</span>&gt;</span><br><span class="line">we import urllib3: &lt;module <span class="string">'socket'</span> from <span class="string">'/path/to/python3.11/socket.py'</span>&gt;</span><br><span class="line"></span><br><span class="line">greendns import dns: import_patched(dns) start</span><br><span class="line">dns import socket:  &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/to/python3.11/site-packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line">greendns import dns: import_patched(dns) end</span><br><span class="line"></span><br><span class="line">dns import socket:  &lt;module <span class="string">'eventlet.green._socket_nodns'</span> from <span class="string">'/path/bo/python3.11/site-</span></span><br><span class="line"><span class="string">packages/eventlet/green/_socket_nodns.py'</span>&gt;</span><br><span class="line"></span><br><span class="line">`dns` import urllib3</span><br><span class="line">greendns setattr start</span><br><span class="line">`dns` import urllib3</span><br><span class="line"></span><br><span class="line">初始 FD：</span><br><span class="line">lsof: WARNING: can<span class="string">'t stat() tracefs file system /sys/kernel/debug/tracing</span></span><br><span class="line"><span class="string">      Output information may be incomplete.</span></span><br><span class="line"><span class="string">     56 REG</span></span><br><span class="line"><span class="string">      7 CHR</span></span><br><span class="line"><span class="string">      2 DIR</span></span><br><span class="line"><span class="string">      1 TYPE</span></span><br><span class="line"><span class="string">      1 FIFO</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">触发请求后 FD：</span></span><br><span class="line"><span class="string">lsof: WARNING: can'</span>t <span class="built_in">stat</span>() tracefs file system /sys/kernel/debug/tracing</span><br><span class="line">      Output information may be incomplete.</span><br><span class="line">     56 REG</span><br><span class="line">      7 CHR</span><br><span class="line">      2 DIR</span><br><span class="line">      1 TYPE</span><br><span class="line">      1 FIFO</span><br></pre></td></tr></table></figure>
<p>可以看到，此时 <code>urllib3</code> 使用的是原生的 <code>socket</code>，此时新开线程（上下文）执行后 FD 自然会被顺利关闭。</p>
<p>所以，归根结底，直接原因是 <code>eventlet</code> 在 <code>monkey_patch</code> 时处理了 <code>socket</code> 和 <code>dns</code>，而 <code>dns</code> 又依赖 <code>urllib3</code>（实际是 <code>requests</code>，一样的），导致其底层使用了 patch 之后的 <code>socket</code>。</p>
<p>这也是 <code>eventlet</code> 官方文档中强调的，一定要在一开始调用 <code>eventlet.monkey_patch()</code>。描述如下：</p>
<blockquote>
<p>It is important to call <a href="https://eventlet.readthedocs.io/en/latest/reference/api/eventlet.html#eventlet.patcher.monkey_patch" target="_blank" rel="noopener"><code>monkey_patch()</code></a><sup>[2]</sup> as early in the lifetime of the application as possible. Try to do it as one of the first lines in the main module. The reason for this is that sometimes there is a class that inherits from a class that needs to be greened – e.g. a class that inherits from socket.socket – and inheritance is done at import time, so therefore the monkeypatching should happen before the derived class is defined. It’s safe to call monkey_patch multiple times.</p>
</blockquote>
<p>至于导入顺序这种方式其实并不是好的实践，也不建议。还是建议在最一开始执行 <code>monkey_patch()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> eventlet</span><br><span class="line">eventlet.monkey_patch()</span><br></pre></td></tr></table></figure>
<p>当然，在这次的案例中，其实我们只需要 patch 掉 <code>thread</code> 就行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eventlet.monkey_patch(thread=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>因为目前只有新开的 <code>thread</code> 线程不是绿色实现。不过一般还是建议保持空参数，把所有的都 patch 掉。</p>
<p>另外，可以在代码中看到目前支持的模块如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eventlet/patcher.py</span></span><br><span class="line">accepted_args = &#123;</span><br><span class="line">    <span class="string">"os"</span>,</span><br><span class="line">    <span class="string">"select"</span>,</span><br><span class="line">    <span class="string">"socket"</span>,</span><br><span class="line">    <span class="string">"thread"</span>,</span><br><span class="line">    <span class="string">"time"</span>,</span><br><span class="line">    <span class="string">"psycopg"</span>,</span><br><span class="line">    <span class="string">"MySQLdb"</span>,</span><br><span class="line">    <span class="string">"builtins"</span>,</span><br><span class="line">    <span class="string">"subprocess"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="暂时这样">暂时这样</h2>
<p>其实，我们的分析并没有结束，还应该进一步去看更底层的代码去观察泄漏位置，不过显然篇幅已经太长了，而且我们基本上清楚了来龙去脉，就留到下次吧。不过，我们也可以用下面的代码先观察一下类似现象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># why/mini_selectors.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> selectors <span class="comment"># select的高层抽象模块</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_fds</span><span class="params">()</span>:</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    cmd = <span class="string">f"lsof -p <span class="subst">&#123;pid&#125;</span> | awk '&#123;&#123;print $5&#125;&#125;' | sort | uniq -c | sort -nr"</span></span><br><span class="line">    out = subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line">    print(out.decode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_epoll</span><span class="params">()</span>:</span></span><br><span class="line">    sel = selectors.DefaultSelector()</span><br><span class="line">    <span class="comment"># 这里不关闭</span></span><br><span class="line">    <span class="comment"># sel.close()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"初始 FD："</span>)</span><br><span class="line">    show_fds()</span><br><span class="line"></span><br><span class="line">    threads = [threading.Thread(target=create_epoll) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">"\n触发请求后 FD："</span>)</span><br><span class="line">    show_fds()</span><br></pre></td></tr></table></figure>
<p>总而言之，这次的“Bug”很显然并不是一个“真正”的 Bug，而是我自己对底层某些包不太了解导致（相信 <code>eventlet</code> 的作者肯定是清楚的）。这也再次给自己敲响警钟——千万不要觉得自己已经熟悉了某个编程语言，顶多只能算知道一点！想想觉得有点搞笑，从 5-6 年前说自己”熟悉 Python“，到最近几年的”比较熟悉“，再到现在的”知道一点“……哎，啥时候才能真正”精通“呢……其实，如果按此标准，那 Java 是稍微知道一点，Rust、JavaScript 是略微知道一点，Elixir、Go 是略微知道一丁点， C/C++ 那就基本不懂了。编程不易呀！</p>
<p>回到这个例子，到目前为止我们可以画出大致逻辑链路：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentry_sdk -&gt;① eventlet -&gt; _socket_nodns -&gt; support/greendns.py -&gt; ② dns -&gt; ③ dns.query -&gt; ④ requests/urllib3</span><br></pre></td></tr></table></figure>
<p>具体的调用链路可以 hook <code>__import__</code>，示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># who_import_me.py</span></span><br><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line">original_import = builtins.__import__</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">traced_import</span><span class="params">(name, globals=None, locals=None, fromlist=<span class="params">()</span>, level=<span class="number">0</span>)</span>:</span></span><br><span class="line">    stack = <span class="string">""</span>.join(traceback.format_stack(limit=<span class="number">5</span>))</span><br><span class="line">    print(<span class="string">f"Importing <span class="subst">&#123;name&#125;</span>, called from:\n<span class="subst">&#123;stack&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">return</span> original_import(name, globals, locals, fromlist, level)</span><br><span class="line"></span><br><span class="line">builtins.__import__ = traced_import</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sentry_sdk</span><br></pre></td></tr></table></figure>
<p>回到我们的逻辑链路，有以下几个关键点：</p>
<ul>
<li>① 这里的前提是安装了 <code>eventlet</code>，否则直接 import error 跳过去了也没问题。</li>
<li>② 这里如果把 <code>_socket_nodns</code> 注释掉也没问题。</li>
<li>③ 这里如果不设置 <code>dns.query</code> 以及调用了 <code>query</code> 的其他几个模块也没问题。</li>
<li>④ 这里不导入 <code>requests</code> 那也没问题。</li>
</ul>
<p>就是因为我们在执行代码里也导入了 <code>requests/urllib3</code> 并发起了调用，并且最关键的是，我们把这个调用丢到了原生线程（而非本来的绿色实现上下文），导致执行完后无法正常释放资源（上下文改变）。</p>
<p>另外，这里虽然是由于 <code>dns.query</code> 导入 <code>requests/urllib3</code> 导致的问题，但其实是由于 <code>urllib3</code> 底层用了 <code>socket -&gt; select</code> 模块，而这模块由于前面导入 <code>eventlet</code> 被 patch 了。</p>
<p>解决方法也很多：</p>
<ul>
<li>卸载 <code>eventlet</code>，前面说过。</li>
<li>升级 <code>dnspython</code>，因为升级后的版本消除了 <code>requests</code> 的依赖，自然没问题。</li>
<li>代码最开始执行 <code>eventlet.monkey_patch</code>。当然，如果像 <code>sentry_sdk</code> 这样内部导入的，你可能都不知道。</li>
</ul>
<p>总之，切记一点：只要用到猴子补丁的地方，就尽量都用猴子补丁的上下文。</p>
<p>另外，不要无脑相信大模型，哪怕它看起来是对的，甚至确实是对的。最好还是自己亲自动手探索验证一下，否则很容易“看起来好像明白了，但其实很多细节一抹黑”。不禁又想起了耗子老哥的那句“细节处全是魔鬼”，缅怀耗子老哥。</p>
<h2 id="简单小结">简单小结</h2>
<p>一个小小的 Bug 居然整出来这么多玩意儿，而且，刚刚才说过，其实现在还没有完全分析完（还可以继续下到 <code>select</code>、 <code>epoll</code> 操作系统交互这一层看看具体泄露情况）。不过本文实在已经很长了，实际上大家看到的已经是整理后的结果，完整的 Debug 过程更繁琐。另外，由于平时比较忙，很难有大片空闲时间，导致这个过程持续了一两周时间，确实有点点影响了其他事情……</p>
<p>总结一下，这是一次由 <code>sentry_sdk</code> 导致的 FD 泄露故障，我们从 <code>eventlet</code> 猴子补丁导致的副作用开始，找到 <code>dns</code> 继而找到 <code>requests</code>，并确认此时底层的 <code>select</code> 已经被绿化，而新开的线程却不是绿色版本（原生线程），从而导致上下文不一致，资源回收失败，表现就是 <code>eventpoll</code> 不断增加。</p>
<h2 id="后续">后续——</h2>
<p>在 GitHub 上发了个 Issue 记录了一下，得到了回复，<code>eventlet</code> 即将从最新的 SDK 中移除，<code>eventlet</code> 本身也即将退役。如官方文档公告（<a href="https://eventlet.readthedocs.io/en/latest/%EF%BC%89%E6%89%80%E5%86%99%EF%BC%9A" target="_blank" rel="noopener">https://eventlet.readthedocs.io/en/latest/）所写：</a></p>
<blockquote>
<p><strong>新的 Eventlet 使用现已被强烈不推荐！请阅读以下内容。</strong></p>
<p>Eventlet 创建于将近 18 年前，当时 CPython 标准库中还没有异步功能。随着时间推移，Eventlet 和 CPython 都在不断演进，但近几年 Eventlet 的维护活动逐渐减少，导致它与 CPython 实现之间的差距越来越大。</p>
<p>这种差距已经过大，可能会在你的应用程序中引发意想不到的副作用和 bug。</p>
<p>Eventlet 现在遵循新的维护策略：</p>
<ul>
<li>只会进行稳定性和 bug 修复方面的维护。</li>
<li>不会再接受新的功能请求，除非这些功能与迁移到 <strong>asyncio</strong> 有关。</li>
<li><strong>不建议在新项目中使用 Eventlet</strong>。</li>
<li>我们的目标是逐步计划 Eventlet 的退役，并为你提供迁移路径，以便摆脱对 Eventlet 的依赖。</li>
</ul>
<p>如果你正在寻找一个用于管理异步网络编程的库，并且尚未使用 Eventlet，我们强烈推荐你使用 <strong>asyncio</strong> ——它是 CPython 标准库官方支持的异步库。</p>
<p>如果你已经在使用 Eventlet，我们希望能在某些使用场景下帮助你迁移到 asyncio；请参考 <em>Migrating off of Eventlet</em>。未来仅会接受与迁移方案相关的新特性。</p>
<p>如果你对维护目标或迁移有任何疑问，请随时开启一个新 issue，我们会乐意回答你的问题。</p>
</blockquote>
<h2 id="references">References</h2>
<p><code>[1]</code> hscspring/fd_leak: fd leak caused by monkey patch.: <em><a href="https://github.com/hscspring/fd_leak" target="_blank" rel="noopener">https://github.com/hscspring/fd_leak</a></em><br>
<code>[2]</code> <code>monkey_patch()</code>: <em><a href="https://eventlet.readthedocs.io/en/latest/reference/api/eventlet.html#eventlet.patcher.monkey_patch" target="_blank" rel="noopener">https://eventlet.readthedocs.io/en/latest/reference/api/eventlet.html#eventlet.patcher.monkey_patch</a></em></p>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/2025/09/21/Python/2025-09-21-FD-Leak/">
    <time datetime="2025-09-21T15:00:00.000Z" class="entry-date">
        2025-09-21
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/Coding/">Coding</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Eventlet/">Eventlet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FD-Leak/">FD Leak</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Monkey-Patch/">Monkey Patch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sentry/">Sentry</a></li></ul>

    </footer>
</article>


    
<nav class="nav-single">
    <h3 class="assistive-text">文章导航</h3>
    
    
        <span class="nav-next"><a href="/2025/09/12/NLP/LLM-Training/2025-09-12-GRPO-Clip/" rel="next">GRPO“又一背锅侠”：Clip的各种拉扯 <span class="meta-nav">→</span></a></span>
    
</nav><!-- .nav-single -->







<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{},"image":{"viewList":["fbook","twi","linkedin","qzone","tsina","douban","weixin","evernotecn"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?'];</script>

<section id="comment">
  <!-- 评论代码 -->
  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
  const gitalk = new Gitalk({
    clientID: '0eb512031083d6e7edfb',
    clientSecret: 'e830808995dd813ca26fed50573760963457da37',
    repo: 'hscspring.github.io',
    owner: 'hscspring',
    admin: ['hscspring'],
    id: md5(location.pathname),
    distractionFreeMode: false
  })
  gitalk.render('gitalk-container')
  </script>
  <!-- 评论代码已完成 -->
</section>

</div></div>
        <div id="secondary" class="widget-area" role="complementary">
  
    
  <aside class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-content">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a><span class="category-list-count">74</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Feeling/">Feeling</a><span class="category-list-count">151</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Thinking/">Thinking</a><span class="category-list-count">39</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Music</h3>
    <div class="widget-content">
      <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=541131&auto=0&height=66"></iframe>
      <!-- 评论代码 -->
      <!-- <audio src="http://qnimg.lovevivian.cn/miss.mp3" controls="controls"
             style="width:100%">
        您的浏览器不支持 audio 标签。
      </audio> -->
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-content">
      <ul>
        
          <li>
            <a href="/2025/09/21/Python/2025-09-21-FD-Leak/">记一次诡异的 FD 泄露：躲在暗处的猴子补丁</a>
          </li>
        
          <li>
            <a href="/2025/09/12/NLP/LLM-Training/2025-09-12-GRPO-Clip/">GRPO“又一背锅侠”：Clip的各种拉扯</a>
          </li>
        
          <li>
            <a href="/2025/08/30/NLP/LLM-Training/2025-08-30-GTPO/">GRPO“第一背锅侠”Token Level X2：GTPO双“T”傍地走</a>
          </li>
        
          <li>
            <a href="/2025/08/14/NLP/LLM-Training/2025-08-14-Token-Level-GSPO-GMPO/">GRPO“第一背锅侠”Token Level X：DAPO/DrGRPO与GSPO/GMPO的殊途同归</a>
          </li>
        
          <li>
            <a href="/2025/08/11/AI/2025-08-11-AI-Develop/">群聊中的AGI拼图：GPT-5发布后关于全模态、推理、世界模型与实时学习的思考</a>
          </li>
        
      </ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-content tagcloud">
      <a href="/tags/AE/" style="font-size: 10px;">AE</a> <a href="/tags/AI/" style="font-size: 19.33px;">AI</a> <a href="/tags/AIGC/" style="font-size: 10.67px;">AIGC</a> <a href="/tags/ALBERT/" style="font-size: 10px;">ALBERT</a> <a href="/tags/AR/" style="font-size: 10px;">AR</a> <a href="/tags/AUC/" style="font-size: 10px;">AUC</a> <a href="/tags/Accuracy/" style="font-size: 10px;">Accuracy</a> <a href="/tags/Activation/" style="font-size: 10px;">Activation</a> <a href="/tags/Activation-Steering/" style="font-size: 10px;">Activation Steering</a> <a href="/tags/Agent/" style="font-size: 10px;">Agent</a> <a href="/tags/Aha/" style="font-size: 10px;">Aha</a> <a href="/tags/Algorithm/" style="font-size: 12.67px;">Algorithm</a> <a href="/tags/Array/" style="font-size: 10px;">Array</a> <a href="/tags/Arrow/" style="font-size: 10px;">Arrow</a> <a href="/tags/Attention/" style="font-size: 12px;">Attention</a> <a href="/tags/Automatic-Speech-Processing/" style="font-size: 10px;">Automatic Speech Processing</a> <a href="/tags/Automation/" style="font-size: 10px;">Automation</a> <a href="/tags/BERT/" style="font-size: 16.67px;">BERT</a> <a href="/tags/BIO/" style="font-size: 10.67px;">BIO</a> <a href="/tags/BIOHD/" style="font-size: 10.67px;">BIOHD</a> <a href="/tags/BM25/" style="font-size: 10px;">BM25</a> <a href="/tags/BPE/" style="font-size: 10px;">BPE</a> <a href="/tags/BabyGrow/" style="font-size: 10px;">BabyGrow</a> <a href="/tags/Backtracking/" style="font-size: 10px;">Backtracking</a> <a href="/tags/Backward/" style="font-size: 10px;">Backward</a> <a href="/tags/Bahdanau-Attention/" style="font-size: 10px;">Bahdanau Attention</a> <a href="/tags/Bart/" style="font-size: 10px;">Bart</a> <a href="/tags/Bayes/" style="font-size: 10px;">Bayes</a> <a href="/tags/Beam-Search/" style="font-size: 10px;">Beam Search</a> <a href="/tags/Bert-Flow/" style="font-size: 10px;">Bert-Flow</a> <a href="/tags/Bi-LSTM/" style="font-size: 10px;">Bi-LSTM</a> <a href="/tags/Biasing/" style="font-size: 10px;">Biasing</a> <a href="/tags/BigCodec/" style="font-size: 10px;">BigCodec</a> <a href="/tags/Binary-Search/" style="font-size: 11.33px;">Binary Search</a> <a href="/tags/Blending/" style="font-size: 10px;">Blending</a> <a href="/tags/Brain/" style="font-size: 10px;">Brain</a> <a href="/tags/Brain-Decoding/" style="font-size: 10px;">Brain Decoding</a> <a href="/tags/Bridge/" style="font-size: 10px;">Bridge</a> <a href="/tags/Business/" style="font-size: 12px;">Business</a> <a href="/tags/C/" style="font-size: 10.67px;">C</a> <a href="/tags/C4/" style="font-size: 10px;">C4</a> <a href="/tags/CCG/" style="font-size: 10.67px;">CCG</a> <a href="/tags/CE-BERT/" style="font-size: 10px;">CE BERT</a> <a href="/tags/CFG/" style="font-size: 10px;">CFG</a> <a href="/tags/CISPO/" style="font-size: 10px;">CISPO</a> <a href="/tags/CKY/" style="font-size: 10px;">CKY</a> <a href="/tags/CNN/" style="font-size: 10px;">CNN</a> <a href="/tags/CRF/" style="font-size: 10px;">CRF</a> <a href="/tags/CS/" style="font-size: 10px;">CS</a> <a href="/tags/CYK/" style="font-size: 10px;">CYK</a> <a href="/tags/Calculus/" style="font-size: 10px;">Calculus</a> <a href="/tags/Camera/" style="font-size: 10px;">Camera</a> <a href="/tags/Cascades/" style="font-size: 10px;">Cascades</a> <a href="/tags/Catalan/" style="font-size: 10px;">Catalan</a> <a href="/tags/ChatBot/" style="font-size: 10px;">ChatBot</a> <a href="/tags/ChatGPT/" style="font-size: 15.33px;">ChatGPT</a> <a href="/tags/Chi2/" style="font-size: 10px;">Chi2</a> <a href="/tags/Chunking/" style="font-size: 10px;">Chunking</a> <a href="/tags/Class-Imbalance-Loss/" style="font-size: 10px;">Class Imbalance Loss</a> <a href="/tags/Classification/" style="font-size: 10.67px;">Classification</a> <a href="/tags/Clip/" style="font-size: 10px;">Clip</a> <a href="/tags/CoT/" style="font-size: 10px;">CoT</a> <a href="/tags/Codec/" style="font-size: 12px;">Codec</a> <a href="/tags/Cognition/" style="font-size: 10.67px;">Cognition</a> <a href="/tags/Collaborative-Filtering/" style="font-size: 10px;">Collaborative Filtering</a> <a href="/tags/Collins-Parser/" style="font-size: 10px;">Collins Parser</a> <a href="/tags/Computational-Linguistics/" style="font-size: 10px;">Computational Linguistics</a> <a href="/tags/Computer/" style="font-size: 10px;">Computer</a> <a href="/tags/Computer-Science/" style="font-size: 12px;">Computer Science</a> <a href="/tags/Confusing-Labels/" style="font-size: 10px;">Confusing Labels</a> <a href="/tags/Context-Engineering/" style="font-size: 10px;">Context Engineering</a> <a href="/tags/Context-Free-Grammars/" style="font-size: 10px;">Context-Free Grammars</a> <a href="/tags/Continual-Pre-training/" style="font-size: 14px;">Continual Pre-training</a> <a href="/tags/Continual-Pretraining/" style="font-size: 10.67px;">Continual Pretraining</a> <a href="/tags/Contrastive-Learning/" style="font-size: 10px;">Contrastive-Learning</a> <a href="/tags/Coordinate-Ascent/" style="font-size: 10px;">Coordinate Ascent</a> <a href="/tags/Cosine/" style="font-size: 10.67px;">Cosine</a> <a href="/tags/Cosine-Similarity/" style="font-size: 10px;">Cosine Similarity</a> <a href="/tags/Cross-Entropy/" style="font-size: 10px;">Cross Entropy</a> <a href="/tags/Cross-brackets/" style="font-size: 10px;">Cross-brackets</a> <a href="/tags/Cross-view/" style="font-size: 10px;">Cross-view</a> <a href="/tags/Ctrl/" style="font-size: 10px;">Ctrl</a> <a href="/tags/Culture/" style="font-size: 10px;">Culture</a> <a href="/tags/DA/" style="font-size: 10px;">DA</a> <a href="/tags/DAC/" style="font-size: 10px;">DAC</a> <a href="/tags/DAPO/" style="font-size: 14px;">DAPO</a> <a href="/tags/DB/" style="font-size: 10.67px;">DB</a> <a href="/tags/DCPO/" style="font-size: 10px;">DCPO</a> <a href="/tags/DNN/" style="font-size: 10px;">DNN</a> <a href="/tags/DP/" style="font-size: 10px;">DP</a> <a href="/tags/DPO/" style="font-size: 10px;">DPO</a> <a href="/tags/Data-Augmentation/" style="font-size: 10px;">Data Augmentation</a> <a href="/tags/Data-Clearing/" style="font-size: 10px;">Data Clearing</a> <a href="/tags/Data-Enhancement/" style="font-size: 10px;">Data Enhancement</a> <a href="/tags/Data-Preprocess/" style="font-size: 10px;">Data Preprocess</a> <a href="/tags/Data-Science/" style="font-size: 14px;">Data Science</a> <a href="/tags/Data-Structure/" style="font-size: 15.33px;">Data Structure</a> <a href="/tags/DataManagement/" style="font-size: 10.67px;">DataManagement</a> <a href="/tags/Database/" style="font-size: 10px;">Database</a> <a href="/tags/DeBERTa/" style="font-size: 10px;">DeBERTa</a> <a href="/tags/Debiasing/" style="font-size: 10px;">Debiasing</a> <a href="/tags/Decoder/" style="font-size: 10px;">Decoder</a> <a href="/tags/Decoding/" style="font-size: 10.67px;">Decoding</a> <a href="/tags/Deep/" style="font-size: 10px;">Deep</a> <a href="/tags/DeepGen/" style="font-size: 10px;">DeepGen</a> <a href="/tags/DeepGraph/" style="font-size: 10px;">DeepGraph</a> <a href="/tags/DeepLearning/" style="font-size: 12px;">DeepLearning</a> <a href="/tags/DeepScaleR/" style="font-size: 10.67px;">DeepScaleR</a> <a href="/tags/DeepSeek/" style="font-size: 10px;">DeepSeek</a> <a href="/tags/DeepSeek-GRM/" style="font-size: 10px;">DeepSeek-GRM</a> <a href="/tags/Dependence/" style="font-size: 10px;">Dependence</a> <a href="/tags/Diary/" style="font-size: 15.33px;">Diary</a> <a href="/tags/Disentangled-Attention/" style="font-size: 10px;">Disentangled Attention</a> <a href="/tags/DistilBERT/" style="font-size: 10px;">DistilBERT</a> <a href="/tags/Distillation/" style="font-size: 10.67px;">Distillation</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Docker-Compose/" style="font-size: 10px;">Docker-Compose</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/Dr-GRPO/" style="font-size: 10px;">Dr GRPO</a> <a href="/tags/DrDAPO/" style="font-size: 10px;">DrDAPO</a> <a href="/tags/DrGRPO/" style="font-size: 10px;">DrGRPO</a> <a href="/tags/Dream/" style="font-size: 10.67px;">Dream</a> <a href="/tags/Dropout/" style="font-size: 10.67px;">Dropout</a> <a href="/tags/Dynamic-Mask/" style="font-size: 10px;">Dynamic-Mask</a> <a href="/tags/EDA/" style="font-size: 10px;">EDA</a> <a href="/tags/EMD/" style="font-size: 10px;">EMD</a> <a href="/tags/ERNIE/" style="font-size: 10px;">ERNIE</a> <a href="/tags/Economics/" style="font-size: 10px;">Economics</a> <a href="/tags/Edit-Distance/" style="font-size: 10px;">Edit Distance</a> <a href="/tags/Efficient-DeepLearning/" style="font-size: 10px;">Efficient-DeepLearning</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/Electra/" style="font-size: 10px;">Electra</a> <a href="/tags/Elixir/" style="font-size: 10.67px;">Elixir</a> <a href="/tags/Ellipsis/" style="font-size: 10px;">Ellipsis</a> <a href="/tags/Embedding/" style="font-size: 11.33px;">Embedding</a> <a href="/tags/Embeddings/" style="font-size: 10.67px;">Embeddings</a> <a href="/tags/Embodied-AI/" style="font-size: 10px;">Embodied AI</a> <a href="/tags/Encoder/" style="font-size: 10px;">Encoder</a> <a href="/tags/Entropy/" style="font-size: 11.33px;">Entropy</a> <a href="/tags/Evaluation/" style="font-size: 10.67px;">Evaluation</a> <a href="/tags/Eventlet/" style="font-size: 10px;">Eventlet</a> <a href="/tags/ExT5/" style="font-size: 10px;">ExT5</a> <a href="/tags/Exam/" style="font-size: 10px;">Exam</a> <a href="/tags/F1/" style="font-size: 10px;">F1</a> <a href="/tags/FD-Leak/" style="font-size: 10px;">FD Leak</a> <a href="/tags/FDW/" style="font-size: 10px;">FDW</a> <a href="/tags/FLAN/" style="font-size: 10px;">FLAN</a> <a href="/tags/FSM/" style="font-size: 10px;">FSM</a> <a href="/tags/Faith/" style="font-size: 10px;">Faith</a> <a href="/tags/FastCuRL/" style="font-size: 10px;">FastCuRL</a> <a href="/tags/Feature-Engineering/" style="font-size: 10px;">Feature Engineering</a> <a href="/tags/Feature-based/" style="font-size: 10px;">Feature-based</a> <a href="/tags/Few-Shot/" style="font-size: 11.33px;">Few-Shot</a> <a href="/tags/Few-shot-Prompting/" style="font-size: 10px;">Few-shot Prompting</a> <a href="/tags/Fine-tuning/" style="font-size: 10px;">Fine-tuning</a> <a href="/tags/Formal-Grammars/" style="font-size: 11.33px;">Formal Grammars</a> <a href="/tags/Forward/" style="font-size: 10px;">Forward</a> <a href="/tags/Full-Text-Search/" style="font-size: 10px;">Full-Text-Search</a> <a href="/tags/Function-Syntax/" style="font-size: 10px;">Function Syntax</a> <a href="/tags/Funk-MF/" style="font-size: 10px;">Funk MF</a> <a href="/tags/Funnel-Transformer/" style="font-size: 10px;">Funnel Transformer</a> <a href="/tags/GAE/" style="font-size: 10px;">GAE</a> <a href="/tags/GBTD/" style="font-size: 10px;">GBTD</a> <a href="/tags/GELU/" style="font-size: 10px;">GELU</a> <a href="/tags/GMPO/" style="font-size: 10.67px;">GMPO</a> <a href="/tags/GP/" style="font-size: 10px;">GP</a> <a href="/tags/GPT-1/" style="font-size: 10px;">GPT-1</a> <a href="/tags/GPT-2/" style="font-size: 10.67px;">GPT-2</a> <a href="/tags/GPT-3/" style="font-size: 10px;">GPT-3</a> <a href="/tags/GPT3/" style="font-size: 10px;">GPT3</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/GRM/" style="font-size: 10px;">GRM</a> <a href="/tags/GRPO/" style="font-size: 14.67px;">GRPO</a> <a href="/tags/GRU/" style="font-size: 10px;">GRU</a> <a href="/tags/GSG/" style="font-size: 10px;">GSG</a> <a href="/tags/GSPO/" style="font-size: 10px;">GSPO</a> <a href="/tags/GTPO/" style="font-size: 10px;">GTPO</a> <a href="/tags/GTPO-S/" style="font-size: 10px;">GTPO-S</a> <a href="/tags/Gan/" style="font-size: 10px;">Gan</a> <a href="/tags/Garden-path/" style="font-size: 10px;">Garden-path</a> <a href="/tags/GiGPO/" style="font-size: 10px;">GiGPO</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Global-Pointer/" style="font-size: 10px;">Global Pointer</a> <a href="/tags/Glow/" style="font-size: 10px;">Glow</a> <a href="/tags/Graceful-Shutdown/" style="font-size: 10px;">Graceful Shutdown</a> <a href="/tags/Gradient-Descent/" style="font-size: 10px;">Gradient Descent</a> <a href="/tags/Graph/" style="font-size: 10.67px;">Graph</a> <a href="/tags/GraphQL/" style="font-size: 10.67px;">GraphQL</a> <a href="/tags/Grid-Grammar/" style="font-size: 10px;">Grid Grammar</a> <a href="/tags/Growth/" style="font-size: 12.67px;">Growth</a> <a href="/tags/H2O-Danube/" style="font-size: 10px;">H2O-Danube</a> <a href="/tags/HMM/" style="font-size: 10.67px;">HMM</a> <a href="/tags/Hard-SVM/" style="font-size: 10px;">Hard-SVM</a> <a href="/tags/Hinge-Loss/" style="font-size: 10px;">Hinge Loss</a> <a href="/tags/Hope/" style="font-size: 10px;">Hope</a> <a href="/tags/Host-only/" style="font-size: 10px;">Host-only</a> <a href="/tags/HuggingLLM/" style="font-size: 10px;">HuggingLLM</a> <a href="/tags/Human-in-Loop/" style="font-size: 10px;">Human-in-Loop</a> <a href="/tags/Human-in-the-Loop/" style="font-size: 10px;">Human-in-the-Loop</a> <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/IE/" style="font-size: 10px;">IE</a> <a href="/tags/IQR/" style="font-size: 10px;">IQR</a> <a href="/tags/Imbalance-Data/" style="font-size: 10px;">Imbalance Data</a> <a href="/tags/Impossible-Triangle/" style="font-size: 10px;">Impossible-Triangle</a> <a href="/tags/In-Context-Learning/" style="font-size: 10.67px;">In-Context Learning</a> <a href="/tags/Industry/" style="font-size: 10px;">Industry</a> <a href="/tags/Inference-Scaling/" style="font-size: 11.33px;">Inference Scaling</a> <a href="/tags/Information-Extraction/" style="font-size: 10px;">Information Extraction</a> <a href="/tags/Information-Theory/" style="font-size: 10px;">Information Theory</a> <a href="/tags/Instruct/" style="font-size: 10px;">Instruct</a> <a href="/tags/InstructGPT/" style="font-size: 10.67px;">InstructGPT</a> <a href="/tags/Instruction-Following/" style="font-size: 12px;">Instruction Following</a> <a href="/tags/Instruction-Inference/" style="font-size: 10px;">Instruction Inference</a> <a href="/tags/Isolation-Forest/" style="font-size: 10px;">Isolation Forest</a> <a href="/tags/ItemCF/" style="font-size: 10px;">ItemCF</a> <a href="/tags/Jaccard/" style="font-size: 10px;">Jaccard</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jax/" style="font-size: 10px;">Jax</a> <a href="/tags/Job/" style="font-size: 10px;">Job</a> <a href="/tags/Jupyter/" style="font-size: 10px;">Jupyter</a> <a href="/tags/K2/" style="font-size: 10px;">K2</a> <a href="/tags/KKT/" style="font-size: 10px;">KKT</a> <a href="/tags/KL/" style="font-size: 10px;">KL</a> <a href="/tags/KS/" style="font-size: 10px;">KS</a> <a href="/tags/Kernel/" style="font-size: 10px;">Kernel</a> <a href="/tags/Kernel-Function/" style="font-size: 10px;">Kernel Function</a> <a href="/tags/Kernel-Method/" style="font-size: 10px;">Kernel Method</a> <a href="/tags/Keyword/" style="font-size: 10px;">Keyword</a> <a href="/tags/Knowledge-Graph/" style="font-size: 10.67px;">Knowledge Graph</a> <a href="/tags/L1/" style="font-size: 10px;">L1</a> <a href="/tags/LCPO/" style="font-size: 10px;">LCPO</a> <a href="/tags/LIMD/" style="font-size: 10.67px;">LIMD</a> <a href="/tags/LIMO/" style="font-size: 11.33px;">LIMO</a> <a href="/tags/LIMR/" style="font-size: 10.67px;">LIMR</a> <a href="/tags/LLM/" style="font-size: 18.67px;">LLM</a> <a href="/tags/LLM-Colosseum/" style="font-size: 10px;">LLM-Colosseum</a> <a href="/tags/LM/" style="font-size: 12px;">LM</a> <a href="/tags/LOF/" style="font-size: 10px;">LOF</a> <a href="/tags/LR/" style="font-size: 10px;">LR</a> <a href="/tags/LSTM/" style="font-size: 10px;">LSTM</a> <a href="/tags/Labeling/" style="font-size: 10px;">Labeling</a> <a href="/tags/Language-Model/" style="font-size: 10.67px;">Language Model</a> <a href="/tags/Lexical-Semantics/" style="font-size: 10px;">Lexical Semantics</a> <a href="/tags/Lexicalism/" style="font-size: 10px;">Lexicalism</a> <a href="/tags/Lexicalized-CFG/" style="font-size: 10px;">Lexicalized CFG</a> <a href="/tags/Lexicalized-Grammars/" style="font-size: 10px;">Lexicalized Grammars</a> <a href="/tags/Life/" style="font-size: 12px;">Life</a> <a href="/tags/Linear-Algebra/" style="font-size: 10px;">Linear Algebra</a> <a href="/tags/Linear-Sturcture/" style="font-size: 10px;">Linear Sturcture</a> <a href="/tags/Linked-List/" style="font-size: 10px;">Linked List</a> <a href="/tags/LinkedList/" style="font-size: 10.67px;">LinkedList</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Llama/" style="font-size: 10px;">Llama</a> <a href="/tags/Logistic-Regression/" style="font-size: 10px;">Logistic Regression</a> <a href="/tags/Lucene/" style="font-size: 10px;">Lucene</a> <a href="/tags/Luong-Attention/" style="font-size: 10px;">Luong Attention</a> <a href="/tags/MEMM/" style="font-size: 10px;">MEMM</a> <a href="/tags/MF/" style="font-size: 10px;">MF</a> <a href="/tags/MIO/" style="font-size: 10px;">MIO</a> <a href="/tags/MM-Fusion/" style="font-size: 10px;">MM Fusion</a> <a href="/tags/MTL/" style="font-size: 11.33px;">MTL</a> <a href="/tags/Machine/" style="font-size: 10px;">Machine</a> <a href="/tags/Machine-Learning/" style="font-size: 14px;">Machine Learning</a> <a href="/tags/Machine-Translation/" style="font-size: 10px;">Machine Translation</a> <a href="/tags/Manacher/" style="font-size: 10px;">Manacher</a> <a href="/tags/Managemnt/" style="font-size: 11.33px;">Managemnt</a> <a href="/tags/MarkBERT/" style="font-size: 10px;">MarkBERT</a> <a href="/tags/Markov/" style="font-size: 10px;">Markov</a> <a href="/tags/Materialized-Views/" style="font-size: 10px;">Materialized Views</a> <a href="/tags/Math/" style="font-size: 10.67px;">Math</a> <a href="/tags/Matplotlib/" style="font-size: 10px;">Matplotlib</a> <a href="/tags/Matrix-Factorization/" style="font-size: 10px;">Matrix Factorization</a> <a href="/tags/Median/" style="font-size: 10px;">Median</a> <a href="/tags/Meta-Learning/" style="font-size: 10px;">Meta Learning</a> <a href="/tags/Metric/" style="font-size: 10px;">Metric</a> <a href="/tags/Minimum-Edit-Distance/" style="font-size: 10px;">Minimum Edit Distance</a> <a href="/tags/Minkowski/" style="font-size: 10px;">Minkowski</a> <a href="/tags/Model-Evaluation/" style="font-size: 10px;">Model Evaluation</a> <a href="/tags/Module/" style="font-size: 10px;">Module</a> <a href="/tags/Monkey-Patch/" style="font-size: 10px;">Monkey Patch</a> <a href="/tags/Multi-Head-Attention/" style="font-size: 10px;">Multi-Head Attention</a> <a href="/tags/Multi-Modal/" style="font-size: 10px;">Multi-Modal</a> <a href="/tags/MultiModal/" style="font-size: 10px;">MultiModal</a> <a href="/tags/Multitask/" style="font-size: 10px;">Multitask</a> <a href="/tags/Multiway-Tree/" style="font-size: 10px;">Multiway Tree</a> <a href="/tags/NAT/" style="font-size: 10px;">NAT</a> <a href="/tags/NER/" style="font-size: 14px;">NER</a> <a href="/tags/NLG/" style="font-size: 11.33px;">NLG</a> <a href="/tags/NLM/" style="font-size: 10.67px;">NLM</a> <a href="/tags/NLP/" style="font-size: 20px;">NLP</a> <a href="/tags/NLU/" style="font-size: 10px;">NLU</a> <a href="/tags/NMT/" style="font-size: 10px;">NMT</a> <a href="/tags/NNW/" style="font-size: 11.33px;">NNW</a> <a href="/tags/NTP/" style="font-size: 10px;">NTP</a> <a href="/tags/Naive-Bayes/" style="font-size: 10px;">Naive Bayes</a> <a href="/tags/Neo4j/" style="font-size: 10px;">Neo4j</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/Ngram/" style="font-size: 10.67px;">Ngram</a> <a href="/tags/NodeJS/" style="font-size: 10px;">NodeJS</a> <a href="/tags/Normalizing-Flow/" style="font-size: 10px;">Normalizing Flow</a> <a href="/tags/NumPy/" style="font-size: 10px;">NumPy</a> <a href="/tags/Numba/" style="font-size: 10px;">Numba</a> <a href="/tags/Numpy/" style="font-size: 10px;">Numpy</a> <a href="/tags/OMNI/" style="font-size: 11.33px;">OMNI</a> <a href="/tags/ORZ/" style="font-size: 10px;">ORZ</a> <a href="/tags/Occupation/" style="font-size: 10px;">Occupation</a> <a href="/tags/One-Shot/" style="font-size: 10.67px;">One-Shot</a> <a href="/tags/Online-Learning/" style="font-size: 10px;">Online Learning</a> <a href="/tags/Online-DPO-R1/" style="font-size: 10.67px;">Online-DPO-R1</a> <a href="/tags/OpenAI/" style="font-size: 10px;">OpenAI</a> <a href="/tags/OpenSource/" style="font-size: 10px;">OpenSource</a> <a href="/tags/Orientation/" style="font-size: 10px;">Orientation</a> <a href="/tags/P-R/" style="font-size: 10px;">P-R</a> <a href="/tags/PCCG/" style="font-size: 10px;">PCCG</a> <a href="/tags/PCFG/" style="font-size: 10px;">PCFG</a> <a href="/tags/PEGASUS/" style="font-size: 10px;">PEGASUS</a> <a href="/tags/PLM/" style="font-size: 10.67px;">PLM</a> <a href="/tags/PPMI/" style="font-size: 10px;">PPMI</a> <a href="/tags/PTM/" style="font-size: 10px;">PTM</a> <a href="/tags/PageRank/" style="font-size: 10px;">PageRank</a> <a href="/tags/Palindromic/" style="font-size: 10px;">Palindromic</a> <a href="/tags/Pandarallel/" style="font-size: 10px;">Pandarallel</a> <a href="/tags/Pandas/" style="font-size: 10.67px;">Pandas</a> <a href="/tags/Partial-Parsing/" style="font-size: 10px;">Partial Parsing</a> <a href="/tags/Passion/" style="font-size: 10px;">Passion</a> <a href="/tags/Pearson/" style="font-size: 10px;">Pearson</a> <a href="/tags/Philosophy/" style="font-size: 10.67px;">Philosophy</a> <a href="/tags/Phrase-Structure-Grammar/" style="font-size: 10px;">Phrase Structure Grammar</a> <a href="/tags/Phrase-Structure-Grammars/" style="font-size: 10px;">Phrase Structure Grammars</a> <a href="/tags/PoS/" style="font-size: 10px;">PoS</a> <a href="/tags/Polars/" style="font-size: 10px;">Polars</a> <a href="/tags/Pooling/" style="font-size: 10px;">Pooling</a> <a href="/tags/Position-Encoding/" style="font-size: 10px;">Position-Encoding</a> <a href="/tags/Post-training/" style="font-size: 16px;">Post-training</a> <a href="/tags/Postgres/" style="font-size: 10.67px;">Postgres</a> <a href="/tags/Pragmatic-Automatic-Processing/" style="font-size: 10px;">Pragmatic Automatic Processing</a> <a href="/tags/Pre-Trained/" style="font-size: 10px;">Pre-Trained</a> <a href="/tags/Pre-Training/" style="font-size: 10px;">Pre-Training</a> <a href="/tags/Pre-training/" style="font-size: 14.67px;">Pre-training</a> <a href="/tags/Precision/" style="font-size: 10px;">Precision</a> <a href="/tags/Pretrain/" style="font-size: 10.67px;">Pretrain</a> <a href="/tags/Pretrained/" style="font-size: 10px;">Pretrained</a> <a href="/tags/Pretraining/" style="font-size: 10.67px;">Pretraining</a> <a href="/tags/Probabilistic-Grammar/" style="font-size: 10px;">Probabilistic Grammar</a> <a href="/tags/Probabilistic-Model/" style="font-size: 10px;">Probabilistic Model</a> <a href="/tags/Promote/" style="font-size: 10px;">Promote</a> <a href="/tags/Prompt/" style="font-size: 12.67px;">Prompt</a> <a href="/tags/ProtoBERT/" style="font-size: 10px;">ProtoBERT</a> <a href="/tags/Pruning/" style="font-size: 10px;">Pruning</a> <a href="/tags/Psychology/" style="font-size: 10.67px;">Psychology</a> <a href="/tags/PyPI/" style="font-size: 10px;">PyPI</a> <a href="/tags/Python/" style="font-size: 18px;">Python</a> <a href="/tags/QA/" style="font-size: 10px;">QA</a> <a href="/tags/Quant/" style="font-size: 10px;">Quant</a> <a href="/tags/Quantization/" style="font-size: 10px;">Quantization</a> <a href="/tags/Query/" style="font-size: 10px;">Query</a> <a href="/tags/Queue/" style="font-size: 10px;">Queue</a> <a href="/tags/Qwen3/" style="font-size: 10px;">Qwen3</a> <a href="/tags/R-Drop/" style="font-size: 10.67px;">R-Drop</a> <a href="/tags/R1/" style="font-size: 11.33px;">R1</a> <a href="/tags/R1-Zero/" style="font-size: 13.33px;">R1-Zero</a> <a href="/tags/RAG/" style="font-size: 10px;">RAG</a> <a href="/tags/RELU/" style="font-size: 10px;">RELU</a> <a href="/tags/RFE/" style="font-size: 10px;">RFE</a> <a href="/tags/RHO/" style="font-size: 10px;">RHO</a> <a href="/tags/RHO-1/" style="font-size: 10px;">RHO-1</a> <a href="/tags/RL/" style="font-size: 13.33px;">RL</a> <a href="/tags/RLHF/" style="font-size: 10px;">RLHF</a> <a href="/tags/RM/" style="font-size: 10.67px;">RM</a> <a href="/tags/RM-R1/" style="font-size: 10px;">RM-R1</a> <a href="/tags/RMSE/" style="font-size: 10px;">RMSE</a> <a href="/tags/RNN/" style="font-size: 10px;">RNN</a> <a href="/tags/ROC/" style="font-size: 10px;">ROC</a> <a href="/tags/RWD/" style="font-size: 10px;">RWD</a> <a href="/tags/Rank/" style="font-size: 10px;">Rank</a> <a href="/tags/RaspberryPi/" style="font-size: 10.67px;">RaspberryPi</a> <a href="/tags/Raspberrypi/" style="font-size: 10px;">Raspberrypi</a> <a href="/tags/Reasoning/" style="font-size: 10px;">Reasoning</a> <a href="/tags/Recall/" style="font-size: 10px;">Recall</a> <a href="/tags/Recommendation/" style="font-size: 12.67px;">Recommendation</a> <a href="/tags/Recursion/" style="font-size: 10.67px;">Recursion</a> <a href="/tags/Reformer/" style="font-size: 10px;">Reformer</a> <a href="/tags/Regex/" style="font-size: 10px;">Regex</a> <a href="/tags/Regular-Expression/" style="font-size: 10px;">Regular Expression</a> <a href="/tags/Reinforcement-Learning/" style="font-size: 10px;">Reinforcement Learning</a> <a href="/tags/Relationship-Extraction/" style="font-size: 10px;">Relationship Extraction</a> <a href="/tags/Representation/" style="font-size: 10.67px;">Representation</a> <a href="/tags/Reqular-Expressions/" style="font-size: 10px;">Reqular Expressions</a> <a href="/tags/Retrieving/" style="font-size: 10px;">Retrieving</a> <a href="/tags/Reward/" style="font-size: 10px;">Reward</a> <a href="/tags/RoBERTa/" style="font-size: 10px;">RoBERTa</a> <a href="/tags/Rotated-Sorted-Array/" style="font-size: 10px;">Rotated Sorted Array</a> <a href="/tags/Rust/" style="font-size: 16px;">Rust</a> <a href="/tags/SCFG/" style="font-size: 10px;">SCFG</a> <a href="/tags/SGD/" style="font-size: 10px;">SGD</a> <a href="/tags/SLM/" style="font-size: 10.67px;">SLM</a> <a href="/tags/SMO/" style="font-size: 10px;">SMO</a> <a href="/tags/SQL/" style="font-size: 10.67px;">SQL</a> <a href="/tags/SRN/" style="font-size: 10px;">SRN</a> <a href="/tags/STaR/" style="font-size: 10px;">STaR</a> <a href="/tags/SVD/" style="font-size: 10px;">SVD++</a> <a href="/tags/SVM/" style="font-size: 10.67px;">SVM</a> <a href="/tags/Scaling/" style="font-size: 10px;">Scaling</a> <a href="/tags/Scaling-Law/" style="font-size: 10px;">Scaling Law</a> <a href="/tags/Seaborn/" style="font-size: 10px;">Seaborn</a> <a href="/tags/Search/" style="font-size: 10.67px;">Search</a> <a href="/tags/Seed-Thinking/" style="font-size: 10px;">Seed-Thinking</a> <a href="/tags/Segmentation/" style="font-size: 10px;">Segmentation</a> <a href="/tags/Selection-Inference/" style="font-size: 10px;">Selection-Inference</a> <a href="/tags/Self-Attention/" style="font-size: 11.33px;">Self-Attention</a> <a href="/tags/Semantic-Automatic-Processing/" style="font-size: 10px;">Semantic Automatic Processing</a> <a href="/tags/Semantic-Similarity/" style="font-size: 10px;">Semantic Similarity</a> <a href="/tags/Senta/" style="font-size: 10px;">Senta</a> <a href="/tags/Sentence-Representation/" style="font-size: 10px;">Sentence Representation</a> <a href="/tags/Sentence-Similarity/" style="font-size: 10px;">Sentence Similarity</a> <a href="/tags/Sentence-BERT/" style="font-size: 10px;">Sentence-BERT</a> <a href="/tags/Sentiment-Classification/" style="font-size: 10px;">Sentiment Classification</a> <a href="/tags/SentimentAnalysis/" style="font-size: 10px;">SentimentAnalysis</a> <a href="/tags/Sentry/" style="font-size: 10px;">Sentry</a> <a href="/tags/Siamese/" style="font-size: 10px;">Siamese</a> <a href="/tags/Sigmoid/" style="font-size: 10px;">Sigmoid</a> <a href="/tags/SimCSE/" style="font-size: 10.67px;">SimCSE</a> <a href="/tags/Similarity/" style="font-size: 10px;">Similarity</a> <a href="/tags/Simon/" style="font-size: 10px;">Simon</a> <a href="/tags/Simple-Zoo/" style="font-size: 10px;">Simple-Zoo</a> <a href="/tags/Simpson-Paradox/" style="font-size: 10px;">Simpson Paradox</a> <a href="/tags/Skill/" style="font-size: 10px;">Skill</a> <a href="/tags/Skywork-Reward/" style="font-size: 10px;">Skywork Reward</a> <a href="/tags/Slide/" style="font-size: 10px;">Slide</a> <a href="/tags/Smoothing/" style="font-size: 10.67px;">Smoothing</a> <a href="/tags/Soft-SVM/" style="font-size: 10px;">Soft-SVM</a> <a href="/tags/Softmax/" style="font-size: 10px;">Softmax</a> <a href="/tags/Sort/" style="font-size: 10.67px;">Sort</a> <a href="/tags/Span/" style="font-size: 11.33px;">Span</a> <a href="/tags/Sparse-Attention/" style="font-size: 10px;">Sparse Attention</a> <a href="/tags/Spell-Check/" style="font-size: 10px;">Spell Check</a> <a href="/tags/Spurious-Reward/" style="font-size: 10px;">Spurious Reward</a> <a href="/tags/SqueezeBERT/" style="font-size: 10px;">SqueezeBERT</a> <a href="/tags/Stable-LM/" style="font-size: 10px;">Stable LM</a> <a href="/tags/Stack/" style="font-size: 10px;">Stack</a> <a href="/tags/Stacking/" style="font-size: 10px;">Stacking</a> <a href="/tags/Statistics/" style="font-size: 10px;">Statistics</a> <a href="/tags/Stirling/" style="font-size: 10px;">Stirling</a> <a href="/tags/Strategic/" style="font-size: 10px;">Strategic</a> <a href="/tags/StratifiedKFold/" style="font-size: 10px;">StratifiedKFold</a> <a href="/tags/String/" style="font-size: 10.67px;">String</a> <a href="/tags/Style/" style="font-size: 10px;">Style</a> <a href="/tags/Substring/" style="font-size: 10px;">Substring</a> <a href="/tags/Summarization/" style="font-size: 10.67px;">Summarization</a> <a href="/tags/Supertagging/" style="font-size: 10px;">Supertagging</a> <a href="/tags/Swap/" style="font-size: 10px;">Swap</a> <a href="/tags/System/" style="font-size: 10.67px;">System</a> <a href="/tags/T5/" style="font-size: 10.67px;">T5</a> <a href="/tags/TF-IDF/" style="font-size: 10px;">TF-IDF</a> <a href="/tags/THW/" style="font-size: 11.33px;">THW</a> <a href="/tags/TS3-Codec/" style="font-size: 10px;">TS3-Codec</a> <a href="/tags/TTRL/" style="font-size: 10px;">TTRL</a> <a href="/tags/TTS/" style="font-size: 14px;">TTS</a> <a href="/tags/Tagging/" style="font-size: 10px;">Tagging</a> <a href="/tags/TanH/" style="font-size: 10px;">TanH</a> <a href="/tags/TensorBay/" style="font-size: 10px;">TensorBay</a> <a href="/tags/Tensorflow/" style="font-size: 10px;">Tensorflow</a> <a href="/tags/Test/" style="font-size: 10px;">Test</a> <a href="/tags/Text-Classification/" style="font-size: 10px;">Text Classification</a> <a href="/tags/Text-Generation/" style="font-size: 10px;">Text Generation</a> <a href="/tags/Text-Normalization/" style="font-size: 10px;">Text Normalization</a> <a href="/tags/TextCNN/" style="font-size: 10.67px;">TextCNN</a> <a href="/tags/TextRank/" style="font-size: 10px;">TextRank</a> <a href="/tags/Thought/" style="font-size: 10.67px;">Thought</a> <a href="/tags/Transformer/" style="font-size: 17.33px;">Transformer</a> <a href="/tags/Transformer-XL/" style="font-size: 10px;">Transformer-XL</a> <a href="/tags/Tree/" style="font-size: 10px;">Tree</a> <a href="/tags/Treebank/" style="font-size: 10px;">Treebank</a> <a href="/tags/Tuning/" style="font-size: 10px;">Tuning</a> <a href="/tags/Tutorial/" style="font-size: 10px;">Tutorial</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/UniLM/" style="font-size: 10px;">UniLM</a> <a href="/tags/Unity-Operation/" style="font-size: 10px;">Unity Operation</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Unsupervised-Elicitation/" style="font-size: 10px;">Unsupervised Elicitation</a> <a href="/tags/UserCF/" style="font-size: 10px;">UserCF</a> <a href="/tags/VAPO/" style="font-size: 10px;">VAPO</a> <a href="/tags/VITS/" style="font-size: 10px;">VITS</a> <a href="/tags/Vagrant/" style="font-size: 10px;">Vagrant</a> <a href="/tags/Valence/" style="font-size: 10px;">Valence</a> <a href="/tags/Vector-Semantics/" style="font-size: 10px;">Vector Semantics</a> <a href="/tags/Verifier/" style="font-size: 10px;">Verifier</a> <a href="/tags/Virtual-Network/" style="font-size: 10px;">Virtual Network</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/Visualization/" style="font-size: 10px;">Visualization</a> <a href="/tags/Viterbi/" style="font-size: 10.67px;">Viterbi</a> <a href="/tags/Vocabulary-Learning/" style="font-size: 10px;">Vocabulary Learning</a> <a href="/tags/VoiceAgent/" style="font-size: 10px;">VoiceAgent</a> <a href="/tags/Voila/" style="font-size: 10px;">Voila</a> <a href="/tags/Voting/" style="font-size: 10px;">Voting</a> <a href="/tags/W2NER/" style="font-size: 11.33px;">W2NER</a> <a href="/tags/WOE/" style="font-size: 10px;">WOE</a> <a href="/tags/Web-Server-Multithreaded-Server/" style="font-size: 10px;">Web Server Multithreaded Server</a> <a href="/tags/Wide/" style="font-size: 10px;">Wide</a> <a href="/tags/Word2vec/" style="font-size: 10px;">Word2vec</a> <a href="/tags/Work/" style="font-size: 10px;">Work</a> <a href="/tags/World-Model/" style="font-size: 10px;">World Model</a> <a href="/tags/XLNet/" style="font-size: 10px;">XLNet</a> <a href="/tags/XTTS/" style="font-size: 10px;">XTTS</a> <a href="/tags/Z-Score/" style="font-size: 10px;">Z-Score</a> <a href="/tags/Zero-Short/" style="font-size: 10px;">Zero-Short</a> <a href="/tags/Zero-Shot/" style="font-size: 11.33px;">Zero-Shot</a> <a href="/tags/Zero-shot/" style="font-size: 10px;">Zero-shot</a> <a href="/tags/ZhouZhihua/" style="font-size: 10px;">ZhouZhihua</a> <a href="/tags/Zipf/" style="font-size: 10px;">Zipf</a> <a href="/tags/Ziya/" style="font-size: 10.67px;">Ziya</a> <a href="/tags/attention-sink/" style="font-size: 10px;">attention sink</a> <a href="/tags/bias/" style="font-size: 10px;">bias</a> <a href="/tags/binning/" style="font-size: 10px;">binning</a> <a href="/tags/emacs/" style="font-size: 10px;">emacs</a> <a href="/tags/few-shot/" style="font-size: 10px;">few-shot</a> <a href="/tags/ffmpeg/" style="font-size: 10px;">ffmpeg</a> <a href="/tags/gpt-oss/" style="font-size: 10px;">gpt-oss</a> <a href="/tags/harmony-format/" style="font-size: 10px;">harmony format</a> <a href="/tags/jpype/" style="font-size: 10px;">jpype</a> <a href="/tags/knowledge-Graph/" style="font-size: 10px;">knowledge Graph</a> <a href="/tags/motion/" style="font-size: 10px;">motion</a> <a href="/tags/node2vec/" style="font-size: 10px;">node2vec</a> <a href="/tags/oat-zero/" style="font-size: 10.67px;">oat-zero</a> <a href="/tags/off-by-one-attention/" style="font-size: 10px;">off-by-one attention</a> <a href="/tags/orz/" style="font-size: 10px;">orz</a> <a href="/tags/s1/" style="font-size: 11.33px;">s1</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/str/" style="font-size: 10px;">str</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/vlc/" style="font-size: 10px;">vlc</a>
    </div>
  </aside>

  
</div>
      </div>
      <footer id="colophon" role="contentinfo">
    <p>&copy; 2025 hscspring
    All rights reserved.</p>
    <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p>
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <!-- <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span> -->
    <!-- <span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span> -->
    <!-- <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次</span> -->

</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script src="/js/navigation.js"></script>

<div id="bg"></div>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>